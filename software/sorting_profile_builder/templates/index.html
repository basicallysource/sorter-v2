{% extends "base.html" %}
{% block title %}Home - Sorting Profile Builder{% endblock %}

{% block content %}
<div class="space-y-6">
    <section class="surface-panel p-4 sm:p-5">
        <div class="mb-3 flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
            <h3 class="text-base font-semibold tracking-wide">Parts Cache</h3>
            <div class="stats text-xs uppercase tracking-wider">Sync + cache management</div>
        </div>

        <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
            <div class="space-y-2">
                <p class="text-sm">
                    <strong>Cached:</strong> {{ cache_count }} parts, {{ cat_count }} categories, {{ color_count }} colors
                    {% if api_total %}
                        / {{ api_total }} total parts on Rebrickable
                    {% endif %}
                </p>
                {% if api_total and cache_count >= api_total %}
                    <p><span class="badge">All parts synced</span></p>
                {% endif %}
            </div>

            <div class="space-y-2">
                <div class="flex flex-wrap gap-2">
                    <button data-ui-btn="1" type="button" id="btn-sync-cats" class="inline-flex h-6 items-center justify-center whitespace-nowrap border border-slate-900 bg-slate-900 px-2 text-xs font-medium leading-none text-white hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-50" onclick="syncCategories()">Sync Categories</button>
                    <button data-ui-btn="1" type="button" id="btn-sync-colors" class="inline-flex h-6 items-center justify-center whitespace-nowrap border border-slate-900 bg-slate-900 px-2 text-xs font-medium leading-none text-white hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-50" onclick="syncColors()">Sync Colors</button>
                    <button data-ui-btn="1" type="button" id="btn-sync-parts" class="inline-flex h-6 items-center justify-center whitespace-nowrap border border-slate-900 bg-slate-900 px-2 text-xs font-medium leading-none text-white hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-50" onclick="syncParts()">Sync Parts</button>
                    <button data-ui-btn="1" type="button" id="btn-import-brickstore" class="inline-flex h-6 items-center justify-center whitespace-nowrap border border-slate-300 bg-white px-2 text-xs font-medium leading-none text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50" onclick="importBrickstore()">Import BrickStore DB</button>
                    <button data-ui-btn="1" type="button" id="btn-sync-prices" class="inline-flex h-6 items-center justify-center whitespace-nowrap border border-slate-300 bg-white px-2 text-xs font-medium leading-none text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50" onclick="syncPrices()">Sync Prices</button>
                    <button data-ui-btn="1" type="button" id="btn-stop-sync" class="hidden inline-flex h-6 items-center justify-center whitespace-nowrap border border-slate-300 bg-white px-2 text-xs font-medium leading-none text-slate-700 hover:border-rose-300 hover:bg-rose-50 hover:text-rose-700 disabled:cursor-not-allowed disabled:opacity-50" onclick="stopSync()">Stop</button>
                </div>
                <div class="progress-info">
                    <progress id="sync-progress" value="0" max="100" class="hidden"></progress>
                    <span id="sync-status" class="text-sm"></span>
                </div>
                <div id="sync-log"></div>
            </div>
        </div>
    </section>

    <section class="surface-panel p-4 sm:p-5">
        <div class="mb-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <h3 class="text-base font-semibold tracking-wide">Sorting Profiles</h3>
            <div class="stats text-xs uppercase tracking-wider">{{ profiles|length if profiles else 0 }} profiles</div>
        </div>

        {% if profiles %}
        <div class="overflow-x-auto">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Parts</th>
                        <th>Categories</th>
                        <th>Updated</th>
                        <th>Path</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in profiles %}
                    <tr id="profile-row-{{ p.id }}">
                        <td><a href="/profile/{{ p.id }}">{{ p.name }}</a></td>
                        <td>{{ p.description }}</td>
                        <td>{{ p.part_count }}</td>
                        <td>{{ p.category_count }}</td>
                        <td>{{ p.updated_at[:10] }}</td>
                        <td class="text-[11px] break-all">{{ p.file_path }}</td>
                        <td><button data-ui-btn="1" type="button" class="inline-flex h-6 items-center justify-center whitespace-nowrap border border-slate-300 bg-white px-2 text-xs font-medium leading-none text-slate-700 hover:border-rose-300 hover:bg-rose-50 hover:text-rose-700" onclick="deleteProfile('{{ p.id }}')">Delete</button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="stats">No profiles yet.</p>
        {% endif %}

        <div class="mt-4">
            <details>
                <summary class="inline-flex h-6 items-center justify-center whitespace-nowrap border border-sky-300 bg-sky-50 px-2 text-xs font-medium leading-none text-sky-700 hover:bg-sky-100">+ New Profile</summary>
                <form id="new-profile-form" onsubmit="createProfile(event)" class="space-y-3">
                    <div class="grid grid-cols-1 gap-3 md:grid-cols-2">
                        <label class="space-y-1">
                            <span class="text-xs font-semibold uppercase tracking-wider stats">Name</span>
                            <input type="text" name="name" required>
                        </label>
                        <label class="space-y-1">
                            <span class="text-xs font-semibold uppercase tracking-wider stats">Description</span>
                            <input type="text" name="description">
                        </label>
                    </div>
                    <button data-ui-btn="1" type="submit" class="inline-flex h-6 items-center justify-center whitespace-nowrap border border-slate-900 bg-slate-900 px-2 text-xs font-medium leading-none text-white hover:bg-slate-800">Create</button>
                </form>
            </details>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
let poll_interval = null;

function updateSyncUI(data) {
    let status = document.getElementById('sync-status');
    let progress = document.getElementById('sync-progress');
    let stop_btn = document.getElementById('btn-stop-sync');
    let sync_btns = document.querySelectorAll('#btn-sync-cats, #btn-sync-colors, #btn-sync-parts, #btn-import-brickstore, #btn-sync-prices');

    status.textContent = data.last_message;

    if (data.running) {
        sync_btns.forEach(b => { b.disabled = true; });
        stop_btn.classList.remove('hidden');
        stop_btn.disabled = false;
        let pct = null;
        if (typeof data.progress_total === 'number' && data.progress_total > 0 && typeof data.progress_current === 'number') {
            pct = Math.round((data.progress_current / data.progress_total) * 100);
        } else if (data.api_total && data.cached_parts > 0) {
            pct = Math.round((data.cached_parts / data.api_total) * 100);
        }
        if (pct !== null) {
            progress.value = pct;
            progress.classList.remove('hidden');
        }
    } else {
        sync_btns.forEach(b => { b.disabled = false; b.removeAttribute('aria-busy'); });
        stop_btn.classList.add('hidden');
        progress.classList.add('hidden');
        if (poll_interval) {
            clearInterval(poll_interval);
            poll_interval = null;
        }
    }

    fetchCacheStats();
}

async function pollSyncStatus() {
    let res = await fetch('/api/sync-status');
    let data = await res.json();
    updateSyncUI(data);
    return data;
}

function startPolling() {
    if (poll_interval) return;
    poll_interval = setInterval(pollSyncStatus, 1500);
}

async function startSync(endpoint) {
    let res = await fetch(endpoint, {method: 'POST'});
    if (res.status === 409) {
        startPolling();
        return;
    }
    if (!res.ok) {
        let data = await res.json().catch(() => ({}));
        document.getElementById('sync-status').textContent = 'Error: ' + (data.detail || res.statusText);
        return;
    }
    startPolling();
}

function syncCategories() { startSync('/api/sync-categories'); }
function syncColors() { startSync('/api/sync-colors'); }
function syncParts() { startSync('/api/sync-parts'); }
function importBrickstore() { startSync('/api/import-brickstore'); }
function syncPrices() { startSync('/api/sync-prices'); }

async function stopSync() {
    document.getElementById('btn-stop-sync').disabled = true;
    await fetch('/api/sync-stop', {method: 'POST'});
}

// on page load, check if a sync is already running
pollSyncStatus().then(data => {
    if (data.running) startPolling();
});

async function createProfile(e) {
    e.preventDefault();
    let form = document.getElementById('new-profile-form');
    let fd = new FormData(form);
    let res = await fetch('/api/profiles', {method: 'POST', body: fd});
    let data = await res.json();
    window.location.href = `/profile/${data.id}`;
}

async function deleteProfile(id) {
    if (!confirm('Delete this profile?')) return;
    await fetch(`/api/profiles/${id}`, {method: 'DELETE'});
    document.getElementById(`profile-row-${id}`).remove();
}
</script>
{% endblock %}
