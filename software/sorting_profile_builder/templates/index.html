{% extends "base.html" %}
{% block title %}Home - Sorting Profile Builder{% endblock %}

{% block content %}
<section>
    <h3>Parts Cache</h3>
    <div class="grid">
        <div>
            <p>
                <strong>Cached:</strong> {{ cache_count }} parts, {{ cat_count }} categories, {{ color_count }} colors
                {% if api_total %}
                    / {{ api_total }} total parts on Rebrickable
                {% endif %}
            </p>
            {% if api_total and cache_count >= api_total %}
                <p><mark>All parts synced</mark></p>
            {% endif %}
        </div>
        <div>
            <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                <button id="btn-sync-cats" onclick="syncCategories()">Sync Categories</button>
                <button id="btn-sync-colors" onclick="syncColors()">Sync Colors</button>
                <button id="btn-sync-parts" onclick="syncParts()">Sync Parts</button>
                <button id="btn-stop-sync" onclick="stopSync()" style="display:none;" class="secondary">Stop</button>
            </div>
            <div class="progress-info" style="margin-top:0.5rem;">
                <progress id="sync-progress" value="0" max="100" style="display:none;"></progress>
                <span id="sync-status"></span>
            </div>
            <div id="sync-log"></div>
        </div>
    </div>
</section>

<hr>

<section>
    <h3>Sorting Profiles</h3>
    {% if profiles %}
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Description</th>
                <th>Parts</th>
                <th>Categories</th>
                <th>Updated</th>
                <th>Path</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for p in profiles %}
            <tr id="profile-row-{{ p.id }}">
                <td><a href="/profile/{{ p.id }}">{{ p.name }}</a></td>
                <td>{{ p.description }}</td>
                <td>{{ p.part_count }}</td>
                <td>{{ p.category_count }}</td>
                <td>{{ p.updated_at[:10] }}</td>
                <td style="font-size:11px;">{{ p.file_path }}</td>
                <td><button class="outline secondary" style="padding:4px 8px;font-size:12px;" onclick="deleteProfile('{{ p.id }}')">Delete</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No profiles yet.</p>
    {% endif %}

    <details>
        <summary>New Profile</summary>
        <form id="new-profile-form" onsubmit="createProfile(event)">
            <div class="grid">
                <label>Name <input type="text" name="name" required></label>
                <label>Description <input type="text" name="description"></label>
            </div>
            <button type="submit">Create</button>
        </form>
    </details>
</section>
{% endblock %}

{% block scripts %}
<script>
let poll_interval = null;

function updateSyncUI(data) {
    let status = document.getElementById('sync-status');
    let progress = document.getElementById('sync-progress');
    let stop_btn = document.getElementById('btn-stop-sync');
    let sync_btns = document.querySelectorAll('#btn-sync-cats, #btn-sync-colors, #btn-sync-parts');

    status.textContent = data.last_message;

    if (data.running) {
        sync_btns.forEach(b => { b.disabled = true; });
        stop_btn.style.display = '';
        stop_btn.disabled = false;
        if (data.api_total && data.cached_parts > 0) {
            let pct = Math.round((data.cached_parts / data.api_total) * 100);
            progress.value = pct;
            progress.style.display = '';
        }
    } else {
        sync_btns.forEach(b => { b.disabled = false; b.removeAttribute('aria-busy'); });
        stop_btn.style.display = 'none';
        if (poll_interval) {
            clearInterval(poll_interval);
            poll_interval = null;
        }
    }

    fetchCacheStats();
}

async function pollSyncStatus() {
    let res = await fetch('/api/sync-status');
    let data = await res.json();
    updateSyncUI(data);
    return data;
}

function startPolling() {
    if (poll_interval) return;
    poll_interval = setInterval(pollSyncStatus, 1500);
}

async function startSync(endpoint) {
    let res = await fetch(endpoint, {method: 'POST'});
    if (res.status === 409) {
        // already running, just start polling
        startPolling();
        return;
    }
    startPolling();
}

function syncCategories() { startSync('/api/sync-categories'); }
function syncColors() { startSync('/api/sync-colors'); }
function syncParts() { startSync('/api/sync-parts'); }

async function stopSync() {
    document.getElementById('btn-stop-sync').disabled = true;
    await fetch('/api/sync-stop', {method: 'POST'});
}

// on page load, check if a sync is already running
pollSyncStatus().then(data => {
    if (data.running) startPolling();
});

async function createProfile(e) {
    e.preventDefault();
    let form = document.getElementById('new-profile-form');
    let fd = new FormData(form);
    let res = await fetch('/api/profiles', {method: 'POST', body: fd});
    let data = await res.json();
    window.location.href = `/profile/${data.id}`;
}

async function deleteProfile(id) {
    if (!confirm('Delete this profile?')) return;
    await fetch(`/api/profiles/${id}`, {method: 'DELETE'});
    document.getElementById(`profile-row-${id}`).remove();
}
</script>
{% endblock %}
